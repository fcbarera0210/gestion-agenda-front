---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import { db } from '../../firebase/client';
import { doc, getDoc, collection, query, where, getDocs } from 'firebase/firestore';
import Scheduler from '../../components/Scheduler';
import type { DocumentData } from 'firebase/firestore';

const { professionalId } = Astro.params;

// Page that displays the booking scheduler for a specific professional

// Fetch professional information and associated services
async function getProfessionalData(id: any) {
  if (!id) return { professional: null, services: [] };

  const profDocRef = doc(db, 'professionals', id);
  const profDocSnap = await getDoc(profDocRef);
  const professional = profDocSnap.exists() ? profDocSnap.data() : null;

  const servicesQuery = query(collection(db, 'services'), where('professionalId', '==', id));
  const servicesSnapshot = await getDocs(servicesQuery);
  const services = servicesSnapshot.docs.map(doc => {
    const data = doc.data() as DocumentData;
    return {
      id: doc.id,
      name: data.name,
      duration: data.duration,
      price: data.price
    };
  });

  return { professional, services };
}

const { professional, services } = await getProfessionalData(professionalId);

if (!professional) {
  return new Response(null, {
    status: 404,
    statusText: 'No encontrado'
  });
}
---

<Layout title={`Agendar con ${professional.displayName}`} professional={professional}>
  <Scheduler
    client:load
    professional={{
      id: professionalId!,
      displayName: professional.displayName,
      title: professional.title,
      photoURL: professional.photoURL
    }}
    services={services}
  />
</Layout>
